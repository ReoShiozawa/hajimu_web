# hajimu_web

**はじむ言語初の外部パッケージ** — HTTP ウェブサーバープラグイン

Python の Flask / Node.js の Express のような、シンプルな API で HTTP サーバーを構築できるプラグインです。

## ✨ 特徴

- 🌐 HTTP/1.1 サーバー（GET / POST / PUT / DELETE / PATCH / OPTIONS / HEAD）
- 🔀 パスルーティング（静的パス + パスパラメータ `:param` + オプショナルパラメータ `:param?` + ワイルドカード）
- 📁 静的ファイル配信（MIME 自動判別 + ETag + Cache-Control + Range リクエスト対応）
- 📂 複数静的ディレクトリ + ディレクトリリスティング
- 📋 JSON / テキスト / HTML / ファイル レスポンスヘルパー
- 🔒 CORS / セキュリティヘッダー / レートリミッタ
- 🧩 ユーザー定義ミドルウェア（パス制限付きチェーン対応）
- 🔗 エラーハンドラチェーン（複数ハンドラ登録可）
- 🗂️ セッション管理（インメモリ + Cookie）
- 📦 gzip 圧縮（Accept-Encoding 自動判定）
- 📤 ファイルアップロード（multipart/form-data）
- 🔗 Keep-Alive 持続接続（完全ループ実装）
- 📡 SSE（Server-Sent Events）リアルタイム配信
- ✅ リクエストバリデーション（必須・長さ・メール・数値・URL）
- 🔌 ルーターマウント（プレフィックス付きルート一括登録）
- 📊 Chunked Transfer Encoding（ストリーミング応答）
- 🤝 コンテンツネゴシエーション（Accept ヘッダー判定）
- 🛡️ Trust Proxy（X-Forwarded-For / X-Forwarded-Proto）
- 🧵 マルチスレッド対応（オプション・mutex 保護）
- ⚡ C 実装による高速動作
- 🖥️ クロスプラットフォーム（macOS / Linux / Windows）

## 📦 インストール

### 方法1: ソースからビルド

```bash
git clone https://github.com/ReoShiozawa/hajimu-web.git
cd hajimu-web
make
make install
```

### 方法2: .hjp ファイルを直接配置

`hajimu_web.hjp` と `hajimu.json` を以下のいずれかに配置:

```
プロジェクト/hajimu_packages/hajimu_web/
~/.hajimu/plugins/hajimu_web/
```

## 🚀 クイックスタート

### Hello World サーバー

```
取り込む "hajimu_web" として ウェブ

ウェブ.サーバー作成(8080)
ウェブ.GET("/", "<h1>こんにちは、はじむ！</h1>")
ウェブ.起動()
```

```bash
nihongo hello.jp
# → http://localhost:8080/ にアクセス
```

### JSON API サーバー

```
取り込む "hajimu_web" として ウェブ

ウェブ.サーバー作成(3000)
ウェブ.CORS有効()

ウェブ.JSON応答("/api/status", 200, "{\"状態\": \"正常\"}")
ウェブ.JSON応答("/api/users", 200, "[{\"名前\": \"太郎\"}, {\"名前\": \"花子\"}]")

ウェブ.起動()
```

### 静的ファイルサーバー

```
取り込む "hajimu_web" として ウェブ

ウェブ.サーバー作成(8000)
ウェブ.静的ファイル("public")
ウェブ.起動()
```

## 📖 API リファレンス

### サーバー管理

| 関数 | 説明 | 引数 |
|------|------|------|
| `サーバー作成(ポート)` | サーバーを初期化 | ポート番号（1〜65535） |
| `起動()` | サーバーを起動（ブロッキング） | なし |
| `停止()` | サーバーを停止 | なし |
| `ポート取得()` | 設定されたポート番号を返す | なし |
| `実行中()` | サーバーが実行中か判定 | なし |

### ルーティング

| 関数 | 説明 | 引数 |
|------|------|------|
| `GET(パス, ハンドラ)` | GET ルートを登録 | パス, レスポンス本文 or 関数 |
| `POST(パス, ハンドラ)` | POST ルートを登録 | パス, レスポンス本文 or 関数 |
| `PUT(パス, ハンドラ)` | PUT ルートを登録 | 同上 |
| `DELETE(パス, ハンドラ)` | DELETE ルートを登録 | 同上 |
| `PATCH(パス, ハンドラ)` | PATCH ルートを登録 | 同上 |
| `ルート追加(メソッド, パス, ステータス, コンテンツタイプ, 本文)` | 汎用ルート登録 | 5引数 |
| `JSON応答(パス, ステータス, JSON文字列)` | JSON レスポンスルート登録 | パス, ステータス, JSON |
| `ルート一覧()` | 登録されたルート一覧 | なし |
| `マウント(プレフィックス, ルート配列)` | ルーター一括マウント | プレフィックス, [["GET", "/path", 関数], ...] |

### レスポンスAPI（v4.0）

| 関数 | 説明 | 引数 |
|------|------|------|
| `JSON送信(値)` | JSON レスポンスを送信 | 辞書 or 配列 |
| `テキスト送信(文字列)` | プレーンテキスト送信 | 文字列 |
| `HTML送信(文字列)` | HTML レスポンス送信 | HTML文字列 |
| `ファイル送信(パス, 名前?)` | ファイルをダウンロード送信 | ファイルパス, DL名(任意) |

### ミドルウェア

| 関数 | 説明 | 引数 |
|------|------|------|
| `ミドルウェア(名前)` | 組込みMWを有効化 | "logger","cors","security","json","form","compression","session","rate_limit" |
| `使用(関数)` | グローバルユーザー定義MW登録 | はじむ関数（偽を返すとリクエスト拒否） |
| `使用(パス, 関数)` | パス制限付きMW登録（v5.0） | パスプレフィックス, はじむ関数 |

### セッション管理（v4.0）

| 関数 | 説明 | 引数 |
|------|------|------|
| `セッション取得(キー)` | セッション変数を取得 | キー文字列 |
| `セッション設定(キー, 値)` | セッション変数を設定 | キー, 値 |
| `セッション削除(キー)` | セッション変数を削除 | キー |
| `セッション破棄()` | セッション全体を破棄 | なし |
| `セッション有効期限(秒)` | セッションタイムアウト設定 | 秒数 |

### SSE — Server-Sent Events（v4.0）

| 関数 | 説明 | 引数 |
|------|------|------|
| `SSE(パス, コールバック?)` | SSE エンドポイント登録 | パス, 接続時コールバック(任意) |
| `SSE送信(パス, イベント, データ)` | 特定パスのクライアントに送信 | パス, イベント名, データ |
| `SSEブロードキャスト(イベント, データ)` | 全クライアントに送信 | イベント名, データ |

### バリデーション（v4.0）

| 関数 | 説明 | ルール例 |
|------|------|---------|
| `バリデーション(値, ルール)` | 値の検証 | "required", "min:3", "max:10", "email", "number", "url" |

### エラーハンドリング

| 関数 | 説明 | 引数 |
|------|------|------|
| `エラーページ(ステータス, HTML)` | 静的エラーページ設定 | ステータスコード, HTML |
| `JSONエラーページ(ステータス, メッセージ)` | JSONエラー設定 | ステータスコード, メッセージ |
| `エラーハンドラ(関数)` | 動的エラーハンドラ登録（v5.0: 最大8個チェーン） | 関数(status, message, req) |

### 設定

| 関数 | 説明 | 引数 |
|------|------|------|
| `静的ファイル(ディレクトリ)` | 静的ファイル配信ディレクトリ設定 | ディレクトリパス |
| `静的ディレクトリ追加(ディレクトリ)` | 追加の静的ディレクトリ登録（v5.0） | ディレクトリパス |
| `ディレクトリ一覧(真偽値)` | ディレクトリリスティング有効化（v5.0） | 真/偽 |
| `CORS有効()` | CORS ヘッダーを有効化 | なし |
| `CORS設定(origin, methods, headers)` | CORS 詳細設定 | 3引数 |
| `キープアライブ(有効, タイムアウト?, 最大?)` | Keep-Alive設定 | 真偽値, 秒数, 最大リクエスト数 |
| `レート制限設定(上限, 秒)` | レートリミッタ設定 | リクエスト数, 期間秒 |
| `圧縮最小サイズ(バイト)` | gzip圧縮発動の最小サイズ | バイト数(default 1024) |
| `HTTPS設定(証明書, 鍵)` | TLS設定（要ビルドフラグ） | 証明書パス, 鍵パス |
| `アップロードディレクトリ(パス)` | アップロード保存先 | ディレクトリパス |
| `アップロード最大サイズ(バイト)` | アップロード上限 | バイト数 |
| `信頼プロキシ(真偽値)` | Trust Proxy 有効化（v5.0） | 真/偽 |
| `最大スレッド数(数)` | 同時処理スレッド数設定（v5.0） | スレッド数 |

### レスポンス拡張 API（v5.0）

| 関数 | 説明 | 引数 |
|------|------|------|
| `リダイレクト(URL)` | 302 リダイレクト | リダイレクト先URL |
| `テンプレート描画(パス, 変数辞書)` | テンプレートレンダリング | テンプレートパス, 変数配列 |
| `書き込み(チャンク)` | Chunked Transfer Encoding 書き込み | 文字列 |
| `応答終了()` | Chunked レスポンス終了 | なし |
| `ヘッダー追加(名前, 値)` | レスポンスヘッダー追記 | ヘッダー名, 値 |
| `場所(URL)` | Location ヘッダー設定 | URL |
| `ダウンロード(パス, ファイル名?)` |  Content-Disposition ダウンロード | ファイルパス, DL名(任意) |

### コンテンツネゴシエーション（v5.0）

| 関数 | 説明 | 引数 |
|------|------|------|
| `受入確認(タイプ)` | Accept ヘッダーにタイプが含まれるか | MIMEタイプ |
| `フォーマット応答(マッピング)` | Accept に応じた分岐応答 | [["text/html", html関数], ["application/json", json関数], ...] |

### リクエスト情報拡張（v5.0）

| フィールド | インデックス | 説明 |
|-----------|-------------|------|
| `リクエスト[5]` | headers | ヘッダー辞書（`headers["Host"]` でアクセス可） |
| `リクエスト[6]` | params | パスパラメータ辞書 |
| `リクエスト[7]` | query | クエリパラメータ辞書 |
| `リクエスト[9]` | form_fields | フォームフィールド辞書 |
| `リクエスト[10]` | cookies | Cookie 辞書 |
| `リクエスト[13]` | hostname | ホスト名（ポートなし） |
| `リクエスト[14]` | protocol | プロトコル（"http" / "https"） |
| `リクエスト[15]` | secure | HTTPS 判定（真/偽） |

## 📂 パスパラメータ

ルートパスに `:パラメータ名` を使用してパスパラメータを定義できます:

```
// "/api/users/42" にマッチ → params["id"] = "42"
ウェブ.GET("/api/users/:id", ユーザー処理)
```

### オプショナルパラメータ（v5.0）

`:パラメータ名?` で省略可能なパラメータを定義できます:

```
// "/items/electronics" にマッチ → params["category"] = "electronics", params["page"] = null
// "/items/electronics/2" にマッチ → params["category"] = "electronics", params["page"] = "2"
ウェブ.GET("/items/:category/:page?", アイテム処理)
```

## 🔧 ビルド

### 必要なもの

- C コンパイラ (gcc / clang)
- はじむヘッダー（`hajimu_plugin.h`）
- POSIX 互換環境（Windows では MinGW）

### コマンド

```bash
make              # ビルド
make clean        # クリーン
make install      # ~/.hajimu/plugins/ にインストール
make uninstall    # アンインストール
make test         # テストサーバー起動
```

### 環境変数

| 変数 | デフォルト | 説明 |
|------|-----------|------|
| `HAJIMU_INCLUDE` | 自動検出 | はじむヘッダーのパス |
| `CC` | `gcc` | C コンパイラ |
| `NIHONGO` | 自動検出 | はじむ実行ファイルパス |

## 📁 ディレクトリ構成

```
jp-web/
├── hajimu.json           # パッケージマニフェスト
├── Makefile              # ビルドファイル
├── README.md             # このファイル
├── src/
│   └── hajimu_web.c      # プラグイン本体
└── examples/
    ├── hello_server.jp   # Hello World サーバー
    ├── api_server.jp     # JSON API サーバー
    ├── static_server.jp  # 静的ファイルサーバー
    └── public/
        └── index.html    # 静的ファイルサンプル
```

## 🏗️ アーキテクチャ

```
はじむコード (.jp)
     │  取り込む "hajimu_web" として ウェブ
     │  ウェブ.サーバー作成(8080)
     │  ウェブ.GET("/", ...)
     │  ウェブ.起動()
     ▼
hajimu_web.hjp (C 共有ライブラリ)
     │  ┌──────────────────────────┐
     │  │  HTTP パーサー            │
     │  │  ルーティングエンジン      │
     │  │  ミドルウェアチェーン      │
     │  │  レスポンスビルダー        │
     │  │  静的ファイル配信 + Range  │
     │  │  Keep-Alive ループ        │
     │  │  Thread Pool (optional)   │
     │  │  POSIX ソケット           │
     │  └──────────────────────────┘
     ▼
OS ソケット API (TCP/IP)
```

## 🤝 プラグイン開発の参考として

このパッケージは、はじむの外部パッケージ開発の**リファレンス実装**として設計されています。
独自のプラグインを開発する際の参考にしてください:

1. `hajimu.json` — パッケージマニフェストの書き方
2. `src/hajimu_web.c` — プラグイン関数の実装パターン
3. `Makefile` — クロスプラットフォームビルド
4. `examples/` — はじむでの使用例

## 📄 ライセンス

MIT License

## 🔗 関連リンク

- [はじむ言語](https://github.com/ReoShiozawa/hajimu)
- [はじむドキュメント](https://reoshiozawa.github.io/hajimu-document/)
- [プラグイン開発ガイド](https://reoshiozawa.github.io/hajimu-document/pages/plugins.html)
